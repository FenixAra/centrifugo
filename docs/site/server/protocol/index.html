



<!DOCTYPE html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
        <meta name="description" content="Centrifugo Documentation">
      
      
        <link rel="canonical" href="https://github.com/centrifugal/centrifugo/server/protocol/">
      
      
        <meta name="author" content="Centrifugal">
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../../images/logo.png">
      <meta name="generator" content="mkdocs-0.17.2, mkdocs-material-2.6.6">
    
    
      
        <title>Client protocol - Centrifugo Documentation</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/application.78aab2dc.css">
      
        <link rel="stylesheet" href="../../assets/stylesheets/application-palette.6079476c.css">
      
    
    
      <script src="../../assets/javascripts/modernizr.1aa3b519.js"></script>
    
    
      <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
      
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
      <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    
    
      <link rel="stylesheet" href="../../theme/styles/extra.css">
    
    
  </head>
  
    
    
    <body dir="ltr" data-md-color-primary="indigo" data-md-color-accent="cyan">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448"
    viewBox="0 0 416 448" id="github">
  <path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19-18.125
        8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19 18.125-8.5
        18.125 8.5 10.75 19 3.125 20.5zM320 304q0 10-3.125 20.5t-10.75
        19-18.125 8.5-18.125-8.5-10.75-19-3.125-20.5 3.125-20.5 10.75-19
        18.125-8.5 18.125 8.5 10.75 19 3.125 20.5zM360
        304q0-30-17.25-51t-46.75-21q-10.25 0-48.75 5.25-17.75 2.75-39.25
        2.75t-39.25-2.75q-38-5.25-48.75-5.25-29.5 0-46.75 21t-17.25 51q0 22 8
        38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0
        37.25-1.75t35-7.375 30.5-15 20.25-25.75 8-38.375zM416 260q0 51.75-15.25
        82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5-41.75
        1.125q-19.5 0-35.5-0.75t-36.875-3.125-38.125-7.5-34.25-12.875-30.25-20.25-21.5-28.75q-15.5-30.75-15.5-82.75
        0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25
        30.875q36.75-8.75 77.25-8.75 37 0 70 8 26.25-20.5
        46.75-30.25t47.25-9.75q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34
        99.5z" />
</svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="drawer">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="search">
    <label class="md-overlay" data-md-component="overlay" for="drawer"></label>
    
      <a href="#client-protocol" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="https://github.com/centrifugal/centrifugo" title="Centrifugo Documentation" class="md-header-nav__button md-logo">
          
            <img src="../../images/logo.png" width="24" height="24">
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            
              <span class="md-header-nav__topic">
                Centrifugo Documentation
              </span>
              <span class="md-header-nav__topic">
                Client protocol
              </span>
            
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          
            <label class="md-icon md-icon--search md-header-nav__button" for="search"></label>
            
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
          
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  


  <a href="https://github.com/centrifugal/centrifugo/" title="Go to repository" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      centrifugal/centrifugo
    </div>
  </a>

          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="drawer">
    <span class="md-nav__button md-logo">
      
        <img src="../../images/logo.png" width="24" height="24">
      
    </span>
    Centrifugo Documentation
  </label>
  
    <div class="md-nav__source">
      


  


  <a href="https://github.com/centrifugal/centrifugo/" title="Go to repository" class="md-source" data-md-source="github">
    
      <div class="md-source__icon">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <use xlink:href="#github" width="24" height="24"></use>
        </svg>
      </div>
    
    <div class="md-source__repository">
      centrifugal/centrifugo
    </div>
  </a>

    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../.." title="Getting Started" class="md-nav__link">
      Getting Started
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../concepts/" title="Concepts" class="md-nav__link">
      Concepts
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3" checked>
    
    <label class="md-nav__link" for="nav-3">
      Server
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        Server
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../" title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../install/" title="Installation" class="md-nav__link">
      Installation
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../configuration/" title="Configuration" class="md-nav__link">
      Configuration
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../admin/" title="Admin web interface" class="md-nav__link">
      Admin web interface
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="toc">
        Client protocol
      </label>
    
    <a href="./" title="Client protocol" class="md-nav__link md-nav__link--active">
      Client protocol
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#what-client-should-do" title="What client should do" class="md-nav__link">
    What client should do
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#top-level-framing" title="Top level framing" class="md-nav__link">
    Top level framing
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#connect" title="Connect" class="md-nav__link">
    Connect
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#subscribe" title="Subscribe" class="md-nav__link">
    Subscribe
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#unsubscribe" title="Unsubscribe" class="md-nav__link">
    Unsubscribe
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#refresh" title="Refresh" class="md-nav__link">
    Refresh
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#rpc-like-calls-publish-history-presence" title="RPC-like calls: publish, history, presence" class="md-nav__link">
    RPC-like calls: publish, history, presence
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#asynchronous-server-to-client-messages" title="Asynchronous server-to-client messages" class="md-nav__link">
    Asynchronous server-to-client messages
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ping-pong" title="Ping Pong" class="md-nav__link">
    Ping Pong
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#handle-disconnects" title="Handle disconnects" class="md-nav__link">
    Handle disconnects
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#handle-errors" title="Handle errors" class="md-nav__link">
    Handle errors
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4">
    
    <label class="md-nav__link" for="nav-4">
      Libraries
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        Libraries
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../libraries/client/" title="Client libraries" class="md-nav__link">
      Client libraries
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../libraries/api/" title="API libraries" class="md-nav__link">
      API libraries
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5" type="checkbox" id="nav-5">
    
    <label class="md-nav__link" for="nav-5">
      Deploy
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-5">
        Deploy
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../deploy/packages/" title="RPM and DEB packages" class="md-nav__link">
      RPM and DEB packages
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../deploy/docker/" title="Docker image" class="md-nav__link">
      Docker image
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../deploy/nginx/" title="Nginx configuration" class="md-nav__link">
      Nginx configuration
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../deploy/tls/" title="TLS" class="md-nav__link">
      TLS
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../deploy/redis/" title="Redis HA" class="md-nav__link">
      Redis HA
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../deploy/tuning/" title="OS tuning" class="md-nav__link">
      OS tuning
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../../faq/" title="FAQ" class="md-nav__link">
      FAQ
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#what-client-should-do" title="What client should do" class="md-nav__link">
    What client should do
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#top-level-framing" title="Top level framing" class="md-nav__link">
    Top level framing
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#connect" title="Connect" class="md-nav__link">
    Connect
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#subscribe" title="Subscribe" class="md-nav__link">
    Subscribe
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#unsubscribe" title="Unsubscribe" class="md-nav__link">
    Unsubscribe
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#refresh" title="Refresh" class="md-nav__link">
    Refresh
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#rpc-like-calls-publish-history-presence" title="RPC-like calls: publish, history, presence" class="md-nav__link">
    RPC-like calls: publish, history, presence
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#asynchronous-server-to-client-messages" title="Asynchronous server-to-client messages" class="md-nav__link">
    Asynchronous server-to-client messages
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ping-pong" title="Ping Pong" class="md-nav__link">
    Ping Pong
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#handle-disconnects" title="Handle disconnects" class="md-nav__link">
    Handle disconnects
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#handle-errors" title="Handle errors" class="md-nav__link">
    Handle errors
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/centrifugal/documentation/edit/master/docs/server/protocol.md" title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                <h1 id="client-protocol">Client protocol<a class="headerlink" href="#client-protocol" title="Permanent link">&para;</a></h1>
<p>This chapter describes internal client-server protocol in details to help developers build custom client libraries.</p>
<p>Note that you can always look at existing client implementations in case of any questions, for example <a href="https://github.com/centrifugal/centrifuge-js/blob/master/src/centrifuge.js">centrifuge-js</a>.</p>
<h3 id="what-client-should-do">What client should do<a class="headerlink" href="#what-client-should-do" title="Permanent link">&para;</a></h3>
<p>When you are using Centrifuge/Centrifugo client you expect some core things from it:</p>
<ul>
<li>connect to server and authenticate. Depending on transport endpoint address can differ. For example Centrifugo JSON-encoded Websocket endpoint is <code class="codehilite">ws://centrifugo.example.com/connection/websocket</code>.</li>
<li>subscribe on channels developer wants. This allows to recieve messages published into channels in real-time.</li>
<li>have a possibility to make RPC calls, publish, asking for presence etc.</li>
<li>refresh client connection credentials when connection session lifetime is going to expire.</li>
<li>handle ping/pong messaging with server under the hood to maintain connection alive and detect broken connection.</li>
<li>handle protocol-specific errors, reconnect and recover missed messages automatically.</li>
</ul>
<p>At moment Centrifuge/Centrifugo can work with several transports:</p>
<ul>
<li>Websocket</li>
<li>SockJS</li>
<li>GRPC</li>
</ul>
<p>This document describes protocol specifics for Websocket transport which supports binary and text formats to transfer data. As Centrifuge has various types of messages it serializes protocol messages using JSON or Protobuf (in case of binary websockets).</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>SockJS works almost the same way as JSON websocket described here but has its own extra framing on top of Centrifuge protocol messages. SockJS can only work with JSON - it's not possible to transfer binary data over it. SockJS is only needed as fallback to Websocket in web browsers.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>GRPC support is an experimental at moment. GRPC works similar to what described here but it has its own transport details - Centrifuge library can not control how data travel over network and just uses GRPC generated API to pass messages between server and client over bidirectional streaming.</p>
</div>
<h3 id="top-level-framing">Top level framing<a class="headerlink" href="#top-level-framing" title="Permanent link">&para;</a></h3>
<p>Centrifuge protocol defined in <a href="https://github.com/centrifugal/centrifuge/blob/master/misc/proto/client.proto">Protobuf schema</a>. That schema is a source of truth and all protocol description below describes messages from that schema.</p>
<p>Client sends <code class="codehilite">Command</code> to server.</p>
<p>Server sends <code class="codehilite">Reply</code> to client.</p>
<p>One request from client to server and one response from server to client can have more than one <code class="codehilite">Command</code> or <code class="codehilite">Reply</code>.</p>
<p>When JSON format is used then many <code class="codehilite">Command</code> can be sent from client to server in JSON streaming line-delimited format. I.e. many commands delimited by new line symbol <code class="codehilite">\n</code>.</p>
<div class="codehilite"><pre><span></span><span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;method&quot;</span><span class="o">:</span> <span class="s2">&quot;subscribe&quot;</span><span class="p">,</span> <span class="s2">&quot;params&quot;</span><span class="o">:</span> <span class="p">{</span><span class="s2">&quot;channel&quot;</span><span class="o">:</span> <span class="s2">&quot;ch1&quot;</span><span class="p">}}</span>
<span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;method&quot;</span><span class="o">:</span> <span class="s2">&quot;subscribe&quot;</span><span class="p">,</span> <span class="s2">&quot;params&quot;</span><span class="o">:</span> <span class="p">{</span><span class="s2">&quot;channel&quot;</span><span class="o">:</span> <span class="s2">&quot;ch2&quot;</span><span class="p">}}</span>
</pre></div>

<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This doc will use JSON format for examples because it's human-readable. Everything said here for JSON is also true for Protobuf encoded case. </p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Method is made as ENUM in protobuf schema and can be sent as integer value but it's possible to send it as string in JSON case – this was made to make JSON protocol human-friendly.</p>
</div>
<p>When Protobuf format is used then many <code class="codehilite">Command</code> can be sent from client to server in length-delimited format where each individual <code class="codehilite">Command</code> marshaled to bytes prepended by <code class="codehilite">varint</code> length.</p>
<p>The same relates to many <code class="codehilite">Reply</code> in one response from server to client. Line-delimited JSON and varint-length prefixed Protobuf.</p>
<p>As you see above each <code class="codehilite">Command</code> has <code class="codehilite">id</code> field. This is an incremental integer field. This field will be echoed in server to client replies to commands so client could match a certain <code class="codehilite">Reply</code> to <code class="codehilite">Command</code> sent before. This is important because Websocket is asynchronous protocol where server and client both send messages in full-duplex mode.</p>
<p>So you can expect something like this when sending commands to server:</p>
<div class="codehilite"><pre><span></span><span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;result&quot;</span><span class="o">:</span> <span class="p">{}}</span>
<span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&quot;result&quot;</span><span class="o">:</span> <span class="p">{}}</span>
</pre></div>

<p>Besides <code class="codehilite">id</code> <code class="codehilite">Reply</code> from server to client have two important fields: <code class="codehilite">result</code> and <code class="codehilite">error</code>.</p>
<p><code class="codehilite">result</code> contains useful payload object which can be different depending on <code class="codehilite">Reply</code>.</p>
<p><code class="codehilite">error</code> contains error object in case of <code class="codehilite">Command</code> processing resulted in some error on server. <code class="codehilite">error</code> is optional and if <code class="codehilite">Reply</code> does not have <code class="codehilite">error</code> then it means that <code class="codehilite">Command</code> processed successfuly and client can parse <code class="codehilite">result</code> object in an appropriate way.</p>
<p><code class="codehilite">error</code> objects looks like this:</p>
<div class="codehilite"><pre><span></span><span class="p">{</span>
    <span class="s2">&quot;code&quot;</span><span class="o">:</span> <span class="mi">100</span><span class="p">,</span>
    <span class="s2">&quot;message&quot;</span><span class="o">:</span> <span class="s2">&quot;internal server error&quot;</span>
<span class="p">}</span>
</pre></div>

<p>We will talk more about error handling below.</p>
<p>The special type of <code class="codehilite">Reply</code> is asynchronous <code class="codehilite">Reply</code>. Those replies have no <code class="codehilite">id</code> field set (or <code class="codehilite">id</code> can be equal to zero). Async replies can come to client in any moment - not as reaction to issued <code class="codehilite">Command</code> but as message from server to client in arbitrary time. For example this can be message published into channel.</p>
<p>Centrifuge library defines several command types client can issue. And well-written client must be aware of all those commands and client workflow. Communication with Centrifuge/Centrifugo server starts with <code class="codehilite">connect</code> command.</p>
<h3 id="connect">Connect<a class="headerlink" href="#connect" title="Permanent link">&para;</a></h3>
<p>First of all client must dial with server and then send <code class="codehilite">connect</code> <code class="codehilite">Command</code> to it.</p>
<p>Default Websocket endpoint in Centrifugo is:</p>
<div class="codehilite"><pre><span></span>ws://centrifugo.example.com/connection/websocket
</pre></div>

<p>In case of using TLS:</p>
<div class="codehilite"><pre><span></span>wss://centrifugo.example.com/connection/websocket
</pre></div>

<p>After successful dial to websocket endpoint client must send <code class="codehilite">connect</code> command to server to authorize itself.</p>
<p><code class="codehilite">connect</code> command looks like:</p>
<div class="codehilite"><pre><span></span><span class="p">{</span>
    <span class="s2">&quot;id&quot;</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s2">&quot;method&quot;</span><span class="o">:</span> <span class="s2">&quot;connect&quot;</span><span class="p">,</span>
    <span class="s2">&quot;params&quot;</span><span class="o">:</span> <span class="p">{</span>
        <span class="s2">&quot;user&quot;</span><span class="o">:</span> <span class="s2">&quot;42&quot;</span><span class="p">,</span>
        <span class="s2">&quot;exp&quot;</span><span class="o">:</span> <span class="s2">&quot;1520094208&quot;</span><span class="p">,</span>
        <span class="s2">&quot;info&quot;</span><span class="o">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;sign&quot;</span><span class="o">:</span> <span class="s2">&quot;xxx&quot;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>

<p>Where params fields are passed to client from application backend:</p>
<ul>
<li>string <code class="codehilite">user</code> - current user ID. Can be empty string for unauthorized user.</li>
<li>string <code class="codehilite">exp</code> - timestamp seconds when client connection expires.</li>
<li>string <code class="codehilite">info</code> - optional base64 encoded information about connection. This is JSON object encoded to base64 in case of JSON format used and arbitrary bytes for Protobuf format.</li>
<li>string <code class="codehilite">sign</code> - HMAC SHA-256 sign generated on backend side from Centrifugo secret and fields above. This sign helps to prove the fact that client passed valid <code class="codehilite">user</code>, <code class="codehilite">exp</code>, <code class="codehilite">info</code> fields to server.</li>
</ul>
<p>In response to <code class="codehilite">connect</code> command server sends connect reply. It looks this way:</p>
<div class="codehilite"><pre><span></span><span class="p">{</span>
    <span class="s2">&quot;id&quot;</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span>
    <span class="s2">&quot;result&quot;</span><span class="o">:</span><span class="p">{</span>
        <span class="s2">&quot;client&quot;</span><span class="o">:</span><span class="s2">&quot;421bf374-dd01-4f82-9def-8c31697e956f&quot;</span><span class="p">,</span>
        <span class="s2">&quot;version&quot;</span><span class="o">:</span><span class="s2">&quot;2.0.0&quot;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>

<p><code class="codehilite">result</code> has some fields:</p>
<ul>
<li>string <code class="codehilite">client</code> - unique client connection ID server issued to this connection</li>
<li>string <code class="codehilite">version</code> - server version</li>
<li>optional bool <code class="codehilite">expires</code> - whether or not server will expire connection</li>
<li>optional bool <code class="codehilite">expired</code> - whether or not connection credentials already expired and must be refreshed</li>
<li>optional int32 <code class="codehilite">ttl</code> - time in seconds until connection will expire</li>
</ul>
<h3 id="subscribe">Subscribe<a class="headerlink" href="#subscribe" title="Permanent link">&para;</a></h3>
<p>As soon as client successfully connected and got unique connection ID it is ready to
subscribe on channels. To do this it must send <code class="codehilite">subscribe</code> command to server:</p>
<div class="codehilite"><pre><span></span><span class="p">{</span>
    <span class="s2">&quot;id&quot;</span><span class="o">:</span> <span class="mi">2</span><span class="p">,</span>
    <span class="s2">&quot;method&quot;</span><span class="o">:</span> <span class="s2">&quot;subscribe&quot;</span><span class="p">,</span>
    <span class="s2">&quot;params&quot;</span><span class="o">:</span> <span class="p">{</span>
        <span class="s2">&quot;channel&quot;</span><span class="o">:</span> <span class="s2">&quot;ch1&quot;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>

<p>Fields that can be set in <code class="codehilite">params</code> are:</p>
<ul>
<li>string <code class="codehilite">channel</code> - channel to subscribe</li>
</ul>
<p>In response to subscribe client receives reply like:</p>
<div class="codehilite"><pre><span></span><span class="p">{</span>
    <span class="s2">&quot;id&quot;</span><span class="o">:</span><span class="mi">2</span><span class="p">,</span>
    <span class="s2">&quot;result&quot;</span><span class="o">:</span><span class="p">{}</span>
<span class="p">}</span>
</pre></div>

<p><code class="codehilite">result</code> can have the following fields:</p>
<ul>
<li>optional array <code class="codehilite">publications</code> - this is an array of missed publications in channel. When received client must call general publication event handler for each message in this array</li>
<li>optional string <code class="codehilite">last</code> - this field contains uid of last publication in channel. This allows fresh client which have not received publications before recover messages setting this value into next subscription request. </li>
<li>optional bool <code class="codehilite">recovered</code> - this flag is set to <code class="codehilite">true</code> when server thinks that all missed publications were successfully recovered and send in subscribe reply (in <code class="codehilite">publications</code> array) and <code class="codehilite">false</code> otherwise.</li>
</ul>
<p>After client received successful reply on <code class="codehilite">subscribe</code> command it will receive asynchronous 
reply messages published to this channel. Messages can be of several types:</p>
<ul>
<li>Publication message</li>
<li>Join message</li>
<li>Leave message</li>
<li>Unsub message</li>
</ul>
<p>See more about asynchronous messages below. </p>
<h3 id="unsubscribe">Unsubscribe<a class="headerlink" href="#unsubscribe" title="Permanent link">&para;</a></h3>
<p>This is simple. When client wants to unsubscribe from channel and therefore stop receiving asynchronous subscription messages from connection related to channel it must call <code class="codehilite">unsubscribe</code> command:</p>
<div class="codehilite"><pre><span></span><span class="p">{</span>
    <span class="s2">&quot;id&quot;</span><span class="o">:</span> <span class="mi">3</span><span class="p">,</span>
    <span class="s2">&quot;method&quot;</span><span class="o">:</span> <span class="s2">&quot;unsubscribe&quot;</span><span class="p">,</span>
    <span class="s2">&quot;params&quot;</span><span class="o">:</span> <span class="p">{</span>
        <span class="s2">&quot;channel&quot;</span><span class="o">:</span> <span class="s2">&quot;ch1&quot;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>

<p>Actually server response does not mean a lot for client - it must immediately remove channel subscription from internal implementation data structures and ignore all messages related to channel.</p>
<h3 id="refresh">Refresh<a class="headerlink" href="#refresh" title="Permanent link">&para;</a></h3>
<p>It's possible to turn on client connection expiration mechanism on server. While enabled server will keep track of connections whose time of life (defined by <code class="codehilite">exp</code> timestamp) is close to the end. In this case connection will be closed. Client can prevent closing connection refreshing it's connection credentials. To do this it must send <code class="codehilite">refresh</code> command to server. <code class="codehilite">refresh</code> command similar to <code class="codehilite">connect</code>:</p>
<div class="codehilite"><pre><span></span><span class="p">{</span>
    <span class="s2">&quot;id&quot;</span><span class="o">:</span> <span class="mi">4</span><span class="p">,</span>
    <span class="s2">&quot;method&quot;</span><span class="o">:</span> <span class="s2">&quot;refresh&quot;</span><span class="p">,</span>
    <span class="s2">&quot;params&quot;</span><span class="o">:</span> <span class="p">{</span>
        <span class="s2">&quot;user&quot;</span><span class="o">:</span> <span class="s2">&quot;42&quot;</span><span class="p">,</span>
        <span class="s2">&quot;exp&quot;</span><span class="o">:</span> <span class="s2">&quot;1520096218&quot;</span><span class="p">,</span>
        <span class="s2">&quot;info&quot;</span><span class="o">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;sign&quot;</span><span class="o">:</span> <span class="s2">&quot;xxx&quot;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>

<p>Just with actual <code class="codehilite">exp</code> and new <code class="codehilite">sign</code>.</p>
<p>The tip whether or not connection must be refreshed comes in reply to <code class="codehilite">connect</code> command shown above - fields <code class="codehilite">expires</code>, <code class="codehilite">expired</code> and <code class="codehilite">ttl</code>.</p>
<p>When client connection expire mechanism is on the value of field <code class="codehilite">expires</code> in connect reply is <code class="codehilite">true</code>. In this case client implementation should look at <code class="codehilite">ttl</code> value which is seconds left until connection will be considered expired. Client must send <code class="codehilite">refresh</code> command after this <code class="codehilite">ttl</code> seconds. Server gives client a configured window to refresh credentials after <code class="codehilite">ttl</code> passed and then closes connection if client have not updated its credentials. <code class="codehilite">expired</code> field set to <code class="codehilite">true</code> when client connection already expired. In this case client should immediately send <code class="codehilite">refresh</code> command to update credentials. And after doing this it can work the usual way.</p>
<h3 id="rpc-like-calls-publish-history-presence">RPC-like calls: publish, history, presence<a class="headerlink" href="#rpc-like-calls-publish-history-presence" title="Permanent link">&para;</a></h3>
<p>The mechanics of these calls is simple - client sends command and expects response from server.</p>
<p><code class="codehilite">publish</code> command allows to publish message into channel from client.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>To publish from client <code class="codehilite">publish</code> option in server configuration must be set to <code class="codehilite">true</code></p>
</div>
<p><code class="codehilite">history</code> allows to ask server for channel history if enabled.</p>
<p><code class="codehilite">presence</code> allows to ask server for channel presence information if enabled.</p>
<h3 id="asynchronous-server-to-client-messages">Asynchronous server-to-client messages<a class="headerlink" href="#asynchronous-server-to-client-messages" title="Permanent link">&para;</a></h3>
<p>There are several types of asynchronous messages that can come from server to client. All of them relate to current client subscriptions.</p>
<p>The most important message is <code class="codehilite">Publication</code>:</p>
<div class="codehilite"><pre><span></span><span class="p">{</span>
    <span class="s2">&quot;result&quot;</span><span class="o">:</span><span class="p">{</span>
        <span class="s2">&quot;channel&quot;</span><span class="o">:</span><span class="s2">&quot;ch1&quot;</span><span class="p">,</span>
        <span class="s2">&quot;data&quot;</span><span class="o">:</span><span class="p">{</span>
            <span class="s2">&quot;uid&quot;</span><span class="o">:</span><span class="s2">&quot;Ry4z8l6GvNMejwMxB7Sohe&quot;</span><span class="p">,</span>
            <span class="s2">&quot;data&quot;</span><span class="o">:</span><span class="p">{</span><span class="s2">&quot;input&quot;</span><span class="o">:</span><span class="s2">&quot;1&quot;</span><span class="p">},</span>
            <span class="s2">&quot;info&quot;</span><span class="o">:</span><span class="p">{</span>
                <span class="s2">&quot;user&quot;</span><span class="o">:</span><span class="s2">&quot;2694&quot;</span><span class="p">,</span>
                <span class="s2">&quot;client&quot;</span><span class="o">:</span><span class="s2">&quot;5c48510e-cf49-4fa8-a9b2-490b22231e74&quot;</span><span class="p">,</span>
                <span class="s2">&quot;conn_info&quot;</span><span class="o">:</span><span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="o">:</span><span class="s2">&quot;Alexander&quot;</span><span class="p">},</span>
                <span class="s2">&quot;chan_info&quot;</span><span class="o">:</span><span class="p">{}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>

<p><code class="codehilite">Publication</code> is a message published into channel. Note that there is no <code class="codehilite">id</code> field in this message - this symptom
allows to distinguish it from <code class="codehilite">Reply</code> to <code class="codehilite">Command</code>.  </p>
<p>Next message is <code class="codehilite">Join</code> message:</p>
<div class="codehilite"><pre><span></span><span class="p">{</span>
    <span class="s2">&quot;result&quot;</span><span class="o">:</span><span class="p">{</span>
        <span class="s2">&quot;type&quot;</span><span class="o">:</span><span class="mi">1</span><span class="p">,</span>
        <span class="s2">&quot;channel&quot;</span><span class="o">:</span><span class="s2">&quot;ch1&quot;</span><span class="p">,</span>
        <span class="s2">&quot;data&quot;</span><span class="o">:</span><span class="p">{</span>
            <span class="s2">&quot;info&quot;</span><span class="o">:</span><span class="p">{</span>
                <span class="s2">&quot;user&quot;</span><span class="o">:</span><span class="s2">&quot;2694&quot;</span><span class="p">,</span>
                <span class="s2">&quot;client&quot;</span><span class="o">:</span><span class="s2">&quot;5c48510e-cf49-4fa8-a9b2-490b22231e74&quot;</span><span class="p">,</span>
                <span class="s2">&quot;conn_info&quot;</span><span class="o">:</span><span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="o">:</span><span class="s2">&quot;Alexander&quot;</span><span class="p">},</span>
                <span class="s2">&quot;chan_info&quot;</span><span class="o">:</span><span class="p">{}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>

<p><code class="codehilite">Join</code> messages sent when someone joined (subscribed on) channel.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>To enable <code class="codehilite">Join</code> and <code class="codehilite">Leave</code> messages <code class="codehilite">join_leave</code> option must be enabled on server globally or for channel namespace.</p>
</div>
<p><code class="codehilite">Leave</code> messages sent when someone left (unsubscribed from) channel.</p>
<div class="codehilite"><pre><span></span><span class="p">{</span>
    <span class="s2">&quot;result&quot;</span><span class="o">:</span><span class="p">{</span>
        <span class="s2">&quot;type&quot;</span><span class="o">:</span><span class="mi">2</span><span class="p">,</span>
        <span class="s2">&quot;channel&quot;</span><span class="o">:</span><span class="s2">&quot;ch1&quot;</span><span class="p">,</span>
        <span class="s2">&quot;data&quot;</span><span class="o">:</span><span class="p">{</span>
            <span class="s2">&quot;info&quot;</span><span class="o">:</span><span class="p">{</span>
                <span class="s2">&quot;user&quot;</span><span class="o">:</span><span class="s2">&quot;2694&quot;</span><span class="p">,</span>
                <span class="s2">&quot;client&quot;</span><span class="o">:</span><span class="s2">&quot;5c48510e-cf49-4fa8-a9b2-490b22231e74&quot;</span><span class="p">,</span>
                <span class="s2">&quot;conn_info&quot;</span><span class="o">:</span><span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="o">:</span><span class="s2">&quot;Alexander&quot;</span><span class="p">},</span>
                <span class="s2">&quot;chan_info&quot;</span><span class="o">:</span><span class="p">{}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>

<p>And finally <code class="codehilite">Unsub</code> message that means that server unsubscribed current client from channel:</p>
<div class="codehilite"><pre><span></span><span class="p">{</span>
    <span class="s2">&quot;result&quot;</span><span class="o">:</span><span class="p">{</span>
        <span class="s2">&quot;type&quot;</span><span class="o">:</span><span class="mi">3</span><span class="p">,</span>
        <span class="s2">&quot;channel&quot;</span><span class="o">:</span><span class="s2">&quot;ch1&quot;</span><span class="p">,</span>
        <span class="s2">&quot;data&quot;</span><span class="o">:</span><span class="p">{}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>

<p>It's possible to distinguish between different types of asynchronous messages looking at <code class="codehilite">type</code> field (for <code class="codehilite">Publication</code> this field not set or <code class="codehilite">0</code>).</p>
<h3 id="ping-pong">Ping Pong<a class="headerlink" href="#ping-pong" title="Permanent link">&para;</a></h3>
<p>To maintain connection alive and detect broken connections client must periodically send <code class="codehilite">ping</code> commands to server and expect replies to it. Ping command looks like:</p>
<div class="codehilite"><pre><span></span><span class="p">{</span>
    <span class="s2">&quot;id&quot;</span><span class="o">:</span><span class="mi">32</span><span class="p">,</span>
    <span class="s2">&quot;method&quot;</span><span class="o">:</span><span class="s2">&quot;ping&quot;</span>
<span class="p">}</span>
</pre></div>

<p>Server just echoes this command back. When client does not receive ping reply for some time it must consider connection broken and try to reconnect. Recommended ping interval is 25 seconds, recommended period to wait for pong is 1-5 seconds. Though those numbers can vary.</p>
<h3 id="handle-disconnects">Handle disconnects<a class="headerlink" href="#handle-disconnects" title="Permanent link">&para;</a></h3>
<p>Client should handle disconnect advices from server. In websocket case disconnect advice is sent in reason field of CLOSE Websocket frame. Reason contains string which is <code class="codehilite">disconnect</code> object encoded into JSON (even in case of Protobuf scenario). That objects looks like:</p>
<div class="codehilite"><pre><span></span><span class="p">{</span>
    <span class="s2">&quot;reason&quot;</span><span class="o">:</span> <span class="s2">&quot;shutdown&quot;</span><span class="p">,</span>
    <span class="s2">&quot;reconnect&quot;</span><span class="o">:</span> <span class="kc">true</span> 
<span class="p">}</span>
</pre></div>

<p>It contains string reason of connection closing and advice to reconnect or not. Client should take this reconnect advice into account.</p>
<p>In case of network problems and random disconnect from server without well known reason client should always try to  reconnect with exponential intervals.</p>
<h3 id="handle-errors">Handle errors<a class="headerlink" href="#handle-errors" title="Permanent link">&para;</a></h3>
<p>This section contains advices to error handling in client implementations.</p>
<p>Errors can happen during various operations and can be handled in special way in context of some commands to tolerate network and server problems.</p>
<p>Errors during <code class="codehilite">connect</code> must result in full client reconnect.</p>
<p>Errors during <code class="codehilite">subscribe</code> must result in full client reconnect if error is temporary. And be sent to subscribe error event handler of subscription if received error is persistent. Persistent errors are errors like <code class="codehilite">permission denied</code>, <code class="codehilite">bad request</code>, <code class="codehilite">namespace not found</code> etc. Persistent errors in most situation mean a mistake from developers side.</p>
<p>The special corner case is client-side timeout during <code class="codehilite">subscribe</code> operation. As protocol is asynchronous it's possible in this case that server will eventually subscribe client on channel but client will think that it's not subscribed. It's possible to retry subscription request and tolerate <code class="codehilite">already subscribed</code> error as expected. But the simplest solution is to reconnect entirely as this is simpler and gives client a chance to connect to working server instance.</p>
<p>Errors during rpc-like operations can be just returned to caller - i.e. user javascript code. Calls like <code class="codehilite">history</code> and <code class="codehilite">presence</code> are idempotent. You should be accurate with unidempotent operations like <code class="codehilite">publish</code> - in case of client timeout it's possible to send the same message into channel twice if retry publish after timeout - so if you care about this case make sure you have some protection from displaying message twice on client side (maybe some sort of unique key in payload).</p>
                
                  
                
              
              
                
              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../admin/" title="Admin web interface" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Admin web interface
              </span>
            </div>
          </a>
        
        
          <a href="../../libraries/client/" title="Client libraries" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Client libraries
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="http://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
        
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../assets/javascripts/application.02434462.js"></script>
      
      <script>app.initialize({version:"0.17.2",url:{base:"../.."}})</script>
      
    
    
      
    
  </body>
</html>